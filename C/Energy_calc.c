#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <stdbool.h>
#include <string.h>

typedef struct {
    char name[100];
    float CPI;
    float L1d_miss_rate;
    float L1i_miss_rate;
    float L2_miss_rate;
    float L1d_accesses;
    float L1i_accesses;
    float L2_accesses;
    float sim_seconds;
} BenchmarkData;

// Δηλώσεις συναρτήσεων
float dynamic_energy(float mem_size, float mem_assoc, float mem_accesses);
float static_energy(float mem_size, float sim_time, bool L1, bool L1d);
float total_energy(float CPI, float L1d_access, float L1d_size, float L1d_assoc, 
                   float L1i_access, float L1i_size, float L1i_assoc, 
                   float L2_access, float L2_size, float L2_assoc, float tsim);

int main() {
    // Δεδομένα από το FINAL_CPI.txt (80 configurations)
    BenchmarkData results[] = {
        {"bzip2_L1i32kBa1_L1d64kBa4_L22MB", 1.668271, 0.013383, 0.000087, 0.316516, 52159972, 10236161, 638302, 0.083414},
        {"bzip2_L1i32kBa1_L1d64kBa4_L24MB", 1.640725, 0.013382, 0.000087, 0.283004, 52166643, 10236150, 638301, 0.082036},
        {"bzip2_L1i32kBa1_L1d64kBa8_L22MB", 1.662000, 0.012775, 0.000087, 0.333060, 52159778, 10236147, 606593, 0.083100},
        {"bzip2_L1i32kBa1_L1d64kBa8_L24MB", 1.634609, 0.012774, 0.000087, 0.297798, 52166417, 10236136, 606592, 0.081730},
        {"bzip2_L1i32kBa1_L1d128kBa4_L22MB", 1.644572, 0.010796, 0.000087, 0.401401, 52157944, 10235924, 503324, 0.082229},
        {"bzip2_L1i32kBa1_L1d128kBa4_L24MB", 1.616918, 0.010794, 0.000087, 0.358897, 52164614, 10235915, 503326, 0.080846},
        {"bzip2_L1i32kBa1_L1d128kBa8_L22MB", 1.640261, 0.010327, 0.000087, 0.421905, 52157822, 10235910, 478859, 0.082013},
        {"bzip2_L1i32kBa1_L1d128kBa8_L24MB", 1.612924, 0.010325, 0.000087, 0.377233, 52164325, 10235900, 478860, 0.080646},
        {"bzip2_L1i32kBa2_L1d64kBa4_L22MB", 1.668391, 0.013383, 0.000075, 0.316558, 52159975, 10236265, 638181, 0.083420},
        {"bzip2_L1i32kBa2_L1d64kBa4_L24MB", 1.640731, 0.013382, 0.000075, 0.283035, 52166627, 10236260, 638176, 0.082037},
        {"bzip2_L1i32kBa2_L1d64kBa8_L22MB", 1.662070, 0.012775, 0.000075, 0.333108, 52159761, 10236250, 606470, 0.083103},
        {"bzip2_L1i32kBa2_L1d64kBa8_L24MB", 1.634570, 0.012773, 0.000075, 0.297831, 52166346, 10236246, 606471, 0.081728},
        {"bzip2_L1i32kBa2_L1d128kBa4_L22MB", 1.644643, 0.010796, 0.000075, 0.401468, 52158030, 10236030, 503203, 0.082232},
        {"bzip2_L1i32kBa2_L1d128kBa4_L24MB", 1.616974, 0.010794, 0.000075, 0.358952, 52164450, 10236022, 503204, 0.080849},
        {"bzip2_L1i32kBa2_L1d128kBa8_L22MB", 1.640385, 0.010327, 0.000075, 0.421987, 52157848, 10236015, 478735, 0.082019},
        {"bzip2_L1i32kBa2_L1d128kBa8_L24MB", 1.612873, 0.010325, 0.000075, 0.377295, 52164332, 10236010, 478739, 0.080644},
        {"bzip2_L1i64kBa4_L1d64kBa4_L2s2MB", 1.660740, 0.013346, 0.000067, 0.316569, 52159168, 10236307, 638091, 0.083037},
        {"bzip2_L1i64kBa4_L1d64kBa4_L2s4MB", 1.635076, 0.013344, 0.000067, 0.283052, 52165952, 10236301, 638091, 0.081754},
        {"bzip2_L1i64kBa8_L1d64kBa8_L2s2MB", 1.654375, 0.012738, 0.000066, 0.333120, 52158838, 10236300, 606382, 0.082719},
        {"bzip2_L1i64kBa8_L1d64kBa8_L2s4MB", 1.628651, 0.012736, 0.000066, 0.297854, 52165391, 10236292, 606381, 0.081433},
        {"bzip2_L1i128kBa4_L1d128kBa4_L2s2MB", 1.637125, 0.010759, 0.000066, 0.401497, 52156802, 10236082, 503114, 0.081856},
        {"bzip2_L1i128kBa4_L1d128kBa4_L2s4MB", 1.611404, 0.010757, 0.000066, 0.358990, 52163487, 10236072, 503114, 0.080570},
        {"bzip2_L1i128kBa8_L1d128kBa8_L2s2MB", 1.632979, 0.010290, 0.000066, 0.422018, 52156459, 10236065, 478645, 0.081649},
        {"bzip2_L1i128kBa8_L1d128kBa8_L2s4MB", 1.607446, 0.010288, 0.000066, 0.377340, 52163100, 10236057, 478648, 0.080372},
        {"mcf_L1i32kBa1_L1d64kBa4_L22MB", 1.132978, 0.001930, 0.004672, 0.220276, 35526681, 26964506, 176156, 0.056649},
        {"mcf_L1i32kBa1_L1d64kBa4_L24MB", 1.132651, 0.001930, 0.004672, 0.219453, 35526681, 26964578, 176156, 0.056633},
        {"mcf_L1i32kBa1_L1d64kBa8_L22MB", 1.132926, 0.001914, 0.004672, 0.220771, 35526681, 26964494, 175761, 0.056646},
        {"mcf_L1i32kBa1_L1d64kBa8_L24MB", 1.132658, 0.001914, 0.004672, 0.219946, 35526681, 26964565, 175761, 0.056633},
        {"mcf_L1i32kBa1_L1d128kBa4_L22MB", 1.132700, 0.001846, 0.004672, 0.222887, 35526681, 26964474, 174093, 0.056635},
        {"mcf_L1i32kBa1_L1d128kBa4_L24MB", 1.132395, 0.001846, 0.004672, 0.222054, 35526681, 26964541, 174093, 0.056620},
        {"mcf_L1i32kBa1_L1d128kBa8_L22MB", 1.132646, 0.001839, 0.004672, 0.223119, 35526681, 26964469, 173912, 0.056632},
        {"mcf_L1i32kBa1_L1d128kBa8_L24MB", 1.132355, 0.001839, 0.004672, 0.222285, 35526681, 26964541, 173912, 0.056618},
        {"mcf_L1i32kBa2_L1d64kBa4_L22MB", 1.108578, 0.001930, 0.000037, 0.758384, 35526696, 26974059, 51168, 0.055429},
        {"mcf_L1i32kBa2_L1d64kBa4_L24MB", 1.108231, 0.001930, 0.000037, 0.755570, 35526696, 26974130, 51168, 0.055412},
        {"mcf_L1i32kBa2_L1d64kBa8_L22MB", 1.108497, 0.001914, 0.000037, 0.764284, 35526696, 26974004, 50773, 0.055425},
        {"mcf_L1i32kBa2_L1d64kBa8_L24MB", 1.108233, 0.001914, 0.000037, 0.761448, 35526696, 26974073, 50773, 0.055412},
        {"mcf_L1i32kBa2_L1d128kBa4_L22MB", 1.108361, 0.001846, 0.000037, 0.790245, 35526696, 26973978, 49105, 0.055418},
        {"mcf_L1i32kBa2_L1d128kBa4_L24MB", 1.108074, 0.001846, 0.000037, 0.787313, 35526696, 26974049, 49105, 0.055404},
        {"mcf_L1i32kBa2_L1d128kBa8_L22MB", 1.108361, 0.001839, 0.000037, 0.793169, 35526696, 26973951, 48924, 0.055418},
        {"mcf_L1i32kBa2_L1d128kBa8_L24MB", 1.108074, 0.001839, 0.000037, 0.790226, 35526696, 26974022, 48924, 0.055404},
        {"mcf_L1i64kBa4_L1d64kBa4_L2s2MB", 1.107753, 0.001930, 0.000019, 0.765596, 35526700, 26974215, 50686, 0.055388},
        {"mcf_L1i64kBa4_L1d64kBa4_L2s4MB", 1.107436, 0.001930, 0.000019, 0.762755, 35526700, 26974284, 50686, 0.055372},
        {"mcf_L1i64kBa8_L1d64kBa8_L2s2MB", 1.107701, 0.001914, 0.000019, 0.771609, 35526700, 26974165, 50291, 0.055385},
        {"mcf_L1i64kBa8_L1d64kBa8_L2s4MB", 1.107384, 0.001914, 0.000019, 0.768746, 35526700, 26974231, 50291, 0.055369},
        {"mcf_L1i128kBa4_L1d128kBa4_L2s2MB", 1.107390, 0.001846, 0.000019, 0.798079, 35526700, 26974149, 48623, 0.055369},
        {"mcf_L1i128kBa4_L1d128kBa4_L2s4MB", 1.107072, 0.001846, 0.000019, 0.795118, 35526700, 26974212, 48623, 0.055354},
        {"mcf_L1i128kBa8_L1d128kBa8_L2s2MB", 1.107389, 0.001839, 0.000019, 0.801061, 35526700, 26974128, 48442, 0.055369},
        {"mcf_L1i128kBa8_L1d128kBa8_L2s4MB", 1.107072, 0.001839, 0.000019, 0.798088, 35526700, 26974191, 48442, 0.055354},
        {"sjeng_L1i32kBa1_L1d64kBa4_L22MB", 10.278747, 0.121829, 0.000021, 0.999971, 86382110, 32134577, 5263997, 0.513937},
        {"sjeng_L1i32kBa1_L1d64kBa4_L24MB", 10.273757, 0.121829, 0.000021, 0.999971, 86382110, 32134578, 5263997, 0.513688},
        {"sjeng_L1i32kBa1_L1d64kBa8_L22MB", 10.278619, 0.121829, 0.000021, 0.999971, 86382110, 32134577, 5263997, 0.513931},
        {"sjeng_L1i32kBa1_L1d64kBa8_L24MB", 10.273769, 0.121829, 0.000021, 0.999971, 86382110, 32134578, 5263997, 0.513688},
        {"sjeng_L1i32kBa1_L1d128kBa4_L22MB", 10.278276, 0.121829, 0.000021, 0.999973, 86382110, 32134574, 5263987, 0.513914},
        {"sjeng_L1i32kBa1_L1d128kBa4_L24MB", 10.271773, 0.121829, 0.000021, 0.999973, 86382108, 32134572, 5263987, 0.513589},
        {"sjeng_L1i32kBa1_L1d128kBa8_L22MB", 10.278362, 0.121829, 0.000021, 0.999972, 86382110, 32134577, 5263990, 0.513918},
        {"sjeng_L1i32kBa1_L1d128kBa8_L24MB", 10.271820, 0.121829, 0.000021, 0.999972, 86382108, 32134575, 5263990, 0.513591},
        {"sjeng_L1i32kBa2_L1d64kBa4_L22MB", 10.276243, 0.121829, 0.000020, 0.999979, 86382112, 32134611, 5263944, 0.513812},
        {"sjeng_L1i32kBa2_L1d64kBa4_L24MB", 10.271888, 0.121829, 0.000020, 0.999979, 86382112, 32134610, 5263944, 0.513594},
        {"sjeng_L1i32kBa2_L1d64kBa8_L22MB", 10.276950, 0.121829, 0.000020, 0.999979, 86382112, 32134612, 5263943, 0.513847},
        {"sjeng_L1i32kBa2_L1d64kBa8_L24MB", 10.271970, 0.121829, 0.000020, 0.999979, 86382112, 32134610, 5263944, 0.513598},
        {"sjeng_L1i32kBa2_L1d128kBa4_L22MB", 10.274925, 0.121829, 0.000020, 0.999981, 86382112, 32134609, 5263935, 0.513746},
        {"sjeng_L1i32kBa2_L1d128kBa4_L24MB", 10.269680, 0.121829, 0.000020, 0.999981, 86382112, 32134610, 5263936, 0.513484},
        {"sjeng_L1i32kBa2_L1d128kBa8_L22MB", 10.275010, 0.121829, 0.000020, 0.999980, 86382112, 32134612, 5263938, 0.513750},
        {"sjeng_L1i32kBa2_L1d128kBa8_L24MB", 10.269783, 0.121829, 0.000020, 0.999980, 86382112, 32134613, 5263939, 0.513489},
        {"sjeng_L1i64kBa4_L1d64kBa4_L2s2MB", 9.875443, 0.121829, 0.000018, 0.999985, 86382111, 32134629, 5263906, 0.493772},
        {"sjeng_L1i64kBa4_L1d64kBa4_L2s4MB", 9.871248, 0.121829, 0.000018, 0.999985, 86382111, 32134633, 5263906, 0.493562},
        {"sjeng_L1i64kBa8_L1d64kBa8_L2s2MB", 9.875515, 0.121829, 0.000018, 0.999986, 86382111, 32134636, 5263903, 0.493776},
        {"sjeng_L1i64kBa8_L1d64kBa8_L2s4MB", 9.871093, 0.121829, 0.000018, 0.999986, 86382111, 32134636, 5263903, 0.493555},
        {"sjeng_L1i128kBa4_L1d128kBa4_L2s2MB", 9.875216, 0.121829, 0.000018, 0.999987, 86382111, 32134634, 5263895, 0.493761},
        {"sjeng_L1i128kBa4_L1d128kBa4_L2s4MB", 9.871404, 0.121829, 0.000018, 0.999987, 86382111, 32134634, 5263895, 0.493570},
        {"sjeng_L1i128kBa8_L1d128kBa8_L2s2MB", 9.875216, 0.121829, 0.000018, 0.999987, 86382111, 32134637, 5263898, 0.493761},
        {"sjeng_L1i128kBa8_L1d128kBa8_L2s4MB", 9.871404, 0.121829, 0.000018, 0.999987, 86382111, 32134637, 5263898, 0.493570},
        {"lbm_L1i32kBa1_L1d64kBa4_L22MB", 3.502986, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.175149},
        {"lbm_L1i32kBa1_L1d64kBa4_L24MB", 3.498645, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.174932},
        {"lbm_L1i32kBa1_L1d64kBa8_L22MB", 3.502986, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.175149},
        {"lbm_L1i32kBa1_L1d64kBa8_L24MB", 3.498645, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.174932},
        {"lbm_L1i32kBa1_L1d128kBa4_L22MB", 3.502986, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.175149},
        {"lbm_L1i32kBa1_L1d128kBa4_L24MB", 3.498645, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.174932},
        {"lbm_L1i32kBa1_L1d128kBa8_L22MB", 3.502986, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.175149},
        {"lbm_L1i32kBa1_L1d128kBa8_L24MB", 3.498645, 0.060971, 0.000114, 0.999861, 48795045, 6046147, 1488303, 0.174932},
        {"lbm_L1i32kBa2_L1d64kBa4_L22MB", 3.495555, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174778},
        {"lbm_L1i32kBa2_L1d64kBa4_L24MB", 3.491403, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174570},
        {"lbm_L1i32kBa2_L1d64kBa8_L22MB", 3.495555, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174778},
        {"lbm_L1i32kBa2_L1d64kBa8_L24MB", 3.491403, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174570},
        {"lbm_L1i32kBa2_L1d128kBa4_L22MB", 3.495555, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174778},
        {"lbm_L1i32kBa2_L1d128kBa4_L24MB", 3.491403, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174570},
        {"lbm_L1i32kBa2_L1d128kBa8_L22MB", 3.495555, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174778},
        {"lbm_L1i32kBa2_L1d128kBa8_L24MB", 3.491403, 0.060971, 0.000099, 0.999926, 48795046, 6046182, 1488207, 0.174570},
        {"lbm_L1i64kBa4_L1d64kBa4_L2s2MB", 3.435670, 0.060971, 0.000086, 0.999980, 48795047, 6046201, 1488129, 0.171784},
        {"lbm_L1i64kBa4_L1d64kBa4_L2s4MB", 3.431821, 0.060971, 0.000086, 0.999980, 48795047, 6046201, 1488129, 0.171591},
        {"lbm_L1i64kBa8_L1d64kBa8_L2s2MB", 3.435670, 0.060971, 0.000085, 0.999983, 48795048, 6046205, 1488125, 0.171784},
        {"lbm_L1i64kBa8_L1d64kBa8_L2s4MB", 3.431933, 0.060971, 0.000085, 0.999983, 48795048, 6046205, 1488125, 0.171597},
        {"lbm_L1i128kBa4_L1d128kBa4_L2s2MB", 3.435670, 0.060971, 0.000085, 0.999983, 48795048, 6046205, 1488125, 0.171784},
        {"lbm_L1i128kBa4_L1d128kBa4_L2s4MB", 3.431933, 0.060971, 0.000085, 0.999983, 48795048, 6046205, 1488125, 0.171597},
        {"lbm_L1i128kBa8_L1d128kBa8_L2s2MB", 3.435670, 0.060971, 0.000085, 0.999983, 48795048, 6046205, 1488125, 0.171784},
        {"lbm_L1i128kBa8_L1d128kBa8_L2s4MB", 3.431933, 0.060971, 0.000085, 0.999983, 48795048, 6046205, 1488125, 0.171597}
    };

    int num_rows = sizeof(results) / sizeof(results[0]);

    // Εκτύπωση Κεφαλίδας
    printf("%-35s | %-8s | %-12s | %-12s\n", 
           "Benchmark", "CPI", "E_total (J)", "EDP");
    printf("-----------------------------------------------------------------------------\n");

    for (int i = 0; i < num_rows; i++) {
        // Μεταβλητές για εξαγωγή από το όνομα
        float l1i_size_kb = 0;
        float l1i_assoc = 0;
        float l1d_size_kb = 0;
        float l1d_assoc = 0;
        float l2_size_mb = 0;
        float l2_assoc = 8; // Default value based on context

        // Parsing ονόματος: "benchmark_L1i[SIZE]Ba[ASSOC]_L1d[SIZE]Ba[ASSOC]_L2[SIZE]"
        char *name = results[i].name;
        
        // --- L1 Instruction Cache Parsing ---
        if (strstr(name, "L1i32k")) l1i_size_kb = 32;
        else if (strstr(name, "L1i64k")) l1i_size_kb = 64;
        else if (strstr(name, "L1i128k")) l1i_size_kb = 128;

        // Έλεγχος για Association μετά το "L1i...Ba"
        // Επειδή το string περιέχει και L1d που έχει "Ba", πρέπει να είμαστε προσεκτικοί.
        // Το L1i assoc είναι το πρώτο "Ba" που εμφανίζεται.
        char *ptr_l1i = strstr(name, "L1i");
        if (ptr_l1i) {
             char *ptr_assoc_i = strstr(ptr_l1i, "Ba");
             if (ptr_assoc_i) {
                 if (ptr_assoc_i[2] == '1') l1i_assoc = 1;
                 else if (ptr_assoc_i[2] == '2') l1i_assoc = 2;
                 else if (ptr_assoc_i[2] == '4') l1i_assoc = 4;
                 else if (ptr_assoc_i[2] == '8') l1i_assoc = 8;
             }
        }

        // --- L1 Data Cache Parsing ---
        if (strstr(name, "L1d64k")) l1d_size_kb = 64;
        else if (strstr(name, "L1d128k")) l1d_size_kb = 128;

        // Το L1d assoc είναι μετά το string "L1d"
        char *ptr_l1d = strstr(name, "L1d");
        if (ptr_l1d) {
             char *ptr_assoc_d = strstr(ptr_l1d, "Ba");
             if (ptr_assoc_d) {
                 if (ptr_assoc_d[2] == '1') l1d_assoc = 1;
                 else if (ptr_assoc_d[2] == '2') l1d_assoc = 2;
                 else if (ptr_assoc_d[2] == '4') l1d_assoc = 4;
                 else if (ptr_assoc_d[2] == '8') l1d_assoc = 8;
             }
        }
        
        // --- L2 Cache Parsing ---
        if (strstr(name, "L22MB")) l2_size_mb = 2;
        else if (strstr(name, "L24MB")) l2_size_mb = 4;

        // Έλεγχος για παλιό format ονόματος (αν υπάρχει μέσα στα δεδομένα)
        // π.χ. bzip2_L1i64kBa4_L1d64kBa4_L2s2MB (τα παλιά 32 runs)
        if (l1i_size_kb == 0) {
             // Fallback logic for old names or implied sizes if logic fails
             // Αλλά τα δεδομένα σου τώρα έχουν όλα L1i/L1d prefixes
             l1i_size_kb = 64; // Fallback
        }

        // Convert to bytes
        float l1i_size_bytes = l1i_size_kb * 1024.0;
        float l1d_size_bytes = l1d_size_kb * 1024.0;
        float l2_size_bytes = l2_size_mb * 1024.0 * 1024.0;

        // Calculate Energy passing SPECIFIC I/D params
        float E_total = total_energy(results[i].CPI, 
                                     results[i].L1d_accesses, l1d_size_bytes, l1d_assoc,
                                     results[i].L1i_accesses, l1i_size_bytes, l1i_assoc,
                                     results[i].L2_accesses, l2_size_bytes, l2_assoc,
                                     results[i].sim_seconds);
        
        float EDP = results[i].CPI * E_total; 

        // Print Row
        printf("%-35s | %8.4f | %12.6f | %12.6f\n", 
               name, 
               results[i].CPI, 
               E_total, 
               EDP);
    }

    return 0;
}

float dynamic_energy(float mem_size, float mem_assoc, float mem_accesses) {
    float dynamic_energy;
    dynamic_energy = (((1.43*pow(10,-5)*mem_size) + (1.02*mem_assoc) - (8.63*pow(10,-7)*mem_size*mem_assoc)-0.73)*mem_accesses)*pow(10,-9);
    return dynamic_energy;
}

float static_energy(float mem_size, float sim_time, bool L1, bool L1d) {
    float static_energy;
    // L1=true -> L1 cache. L1d=true -> Data Cache (Leakage factor might differ)
    static_energy = ((1.01*pow(10,-7)*L1*L1d +6.25*pow(10,-8)*L1*(!L1d) + 4.29*pow(10,-8)*(!L1))*mem_size*sim_time);
    return static_energy;
}

float total_energy(float CPI, float L1d_access, float L1d_size, float L1d_assoc, 
                   float L1i_access, float L1i_size, float L1i_assoc, 
                   float L2_access, float L2_size, float L2_assoc, float tsim) {
    float sum_dynamic_energy, sum_static_energy;

    // Calc Dynamic for L1d, L1i, L2 separately
    sum_dynamic_energy = dynamic_energy(L1d_size, L1d_assoc, L1d_access) + 
                         dynamic_energy(L1i_size, L1i_assoc, L1i_access) + 
                         dynamic_energy(L2_size, L2_assoc, L2_access);

    // Calc Static for L1d, L1i, L2 separately
    sum_static_energy = static_energy(L1d_size, tsim, true, true) + 
                        static_energy(L1i_size, tsim, true, false) + 
                        static_energy(L2_size, tsim, false, false);

    return sum_dynamic_energy + sum_static_energy;
}